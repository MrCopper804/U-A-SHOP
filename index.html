<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>U-A-SHOP | Online Shopping</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9', // Sky blue
                            600: '#0284c7',
                            700: '#0369a1',
                            900: '#0c4a6e',
                        },
                        daraz: {
                            orange: '#f85606',
                            red: '#ff4747'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .dark ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Utilities */
        .hidden-view {
            display: none !important;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity:1; transform: translateY(0); }
        }

        /* Loader */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #f85606;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Product Card Hover */
        .product-card {
            transition: all 0.2s ease;
        }
        .product-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-200">

    <!-- Navbar -->
    <nav class="sticky top-0 z-50 bg-white dark:bg-gray-800 shadow-md border-b border-gray-200 dark:border-gray-700">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <!-- Logo -->
            <div class="flex items-center gap-4">
                <a href="#" onclick="router('home')" class="text-2xl font-bold text-daraz-orange tracking-tighter flex items-center gap-2">
                    <i class="fa-solid fa-bag-shopping"></i> U-A-SHOP
                </a>
                
                <!-- Search Bar (Desktop) -->
                <div class="hidden md:flex relative w-96">
                    <input type="text" id="searchInput" placeholder="Search in U-A-SHOP" 
                        class="w-full pl-4 pr-10 py-2 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700 focus:outline-none focus:border-brand-500 transition-colors">
                    <button onclick="handleSearch()" class="absolute right-0 top-0 h-full px-3 text-gray-500 hover:text-daraz-orange">
                        <i class="fa-solid fa-search"></i>
                    </button>
                </div>
            </div>

            <!-- Right Actions -->
            <div class="flex items-center gap-4 md:gap-6">
                <!-- Dark Mode Toggle -->
                <button onclick="toggleDarkMode()" class="text-gray-500 hover:text-brand-500 transition-colors">
                    <i class="fa-solid fa-moon dark:hidden"></i>
                    <i class="fa-solid fa-sun hidden dark:block text-yellow-400"></i>
                </button>

                <!-- Cart -->
                <div class="relative cursor-pointer hover:text-daraz-orange transition-colors" onclick="router('cart')">
                    <i class="fa-solid fa-cart-shopping text-xl"></i>
                    <span id="cartCountBadge" class="absolute -top-2 -right-2 bg-daraz-orange text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">0</span>
                </div>

                <!-- User Menu -->
                <div id="authSection" class="flex items-center gap-2">
                    <!-- Injected via JS -->
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main id="app" class="container mx-auto px-4 py-6 min-h-screen">
        
        <!-- Loading Spinner Overlay -->
        <div id="globalLoader" class="fixed inset-0 bg-white/80 dark:bg-gray-900/80 z-[100] flex items-center justify-center hidden">
            <div class="loader"></div>
        </div>

        <!-- VIEW: HOME -->
        <div id="view-home" class="fade-in">
            <!-- Hero Banner -->
            <div class="w-full h-48 md:h-80 bg-gradient-to-r from-brand-600 to-brand-900 rounded-xl mb-8 relative overflow-hidden shadow-lg flex items-center justify-center text-white">
                <div class="absolute inset-0 bg-black/20"></div>
                <div class="relative z-10 text-center px-4">
                    <h1 class="text-3xl md:text-5xl font-bold mb-2">Welcome to U-A-SHOP</h1>
                    <p class="text-lg md:text-xl opacity-90">Physical & Digital Products at Best Prices</p>
                </div>
                <img src="https://firebasestorage.googleapis.com/v0/b/u-a-shop.firebasestorage.app/o/generated_images%2Fbanner_1715766825532.png?alt=media&token=placeholder" 
                     onerror="this.src='https://images.unsplash.com/photo-1607082348824-0a96f2a4b9da?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&q=80'"
                     class="absolute inset-0 w-full h-full object-cover opacity-30 mix-blend-overlay" alt="Banner">
            </div>

            <!-- Categories -->
            <div class="flex gap-4 overflow-x-auto pb-4 mb-6 scrollbar-hide">
                <button onclick="filterCategory('all')" class="px-6 py-2 bg-white dark:bg-gray-800 rounded-full shadow-sm border border-gray-200 dark:border-gray-700 hover:bg-daraz-orange hover:text-white transition-colors whitespace-nowrap font-medium">All</button>
                <button onclick="filterCategory('Electronics')" class="px-6 py-2 bg-white dark:bg-gray-800 rounded-full shadow-sm border border-gray-200 dark:border-gray-700 hover:bg-daraz-orange hover:text-white transition-colors whitespace-nowrap font-medium">Electronics</button>
                <button onclick="filterCategory('Fashion')" class="px-6 py-2 bg-white dark:bg-gray-800 rounded-full shadow-sm border border-gray-200 dark:border-gray-700 hover:bg-daraz-orange hover:text-white transition-colors whitespace-nowrap font-medium">Fashion</button>
                <button onclick="filterCategory('Digital')" class="px-6 py-2 bg-white dark:bg-gray-800 rounded-full shadow-sm border border-gray-200 dark:border-gray-700 hover:bg-daraz-orange hover:text-white transition-colors whitespace-nowrap font-medium">Digital Goods</button>
                <button onclick="filterCategory('Home')" class="px-6 py-2 bg-white dark:bg-gray-800 rounded-full shadow-sm border border-gray-200 dark:border-gray-700 hover:bg-daraz-orange hover:text-white transition-colors whitespace-nowrap font-medium">Home</button>
            </div>

            <!-- Product Grid -->
            <div id="productGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                <!-- Products injected here -->
            </div>
        </div>

        <!-- VIEW: AUTH (LOGIN/SIGNUP) -->
        <div id="view-auth" class="hidden-view fade-in max-w-md mx-auto mt-10">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8 border border-gray-200 dark:border-gray-700">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-daraz-orange">U-A-SHOP</h2>
                    <p class="text-gray-500 dark:text-gray-400">Sign in to your account</p>
                </div>

                <form id="authForm" onsubmit="handleAuthSubmit(event)">
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-1">Email</label>
                        <input type="email" id="authEmail" required class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-brand-500">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium mb-1">Password</label>
                        <input type="password" id="authPassword" required class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-brand-500">
                    </div>
                    
                    <button type="submit" id="authBtn" class="w-full bg-daraz-orange text-white py-2 rounded-lg font-bold hover:bg-orange-600 transition-colors">
                        Login
                    </button>
                </form>

                <div class="mt-4 text-center text-sm">
                    <span id="authToggleText" class="text-gray-600 dark:text-gray-400">Don't have an account? </span>
                    <button onclick="toggleAuthMode()" class="text-brand-600 font-semibold hover:underline">Sign Up</button>
                </div>
            </div>
        </div>

        <!-- VIEW: CART -->
        <div id="view-cart" class="hidden-view fade-in">
            <h2 class="text-2xl font-bold mb-6">Shopping Cart</h2>
            <div class="flex flex-col lg:flex-row gap-6">
                <!-- Cart Items -->
                <div class="flex-1 bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4 border border-gray-200 dark:border-gray-700">
                    <div id="cartItemsContainer" class="space-y-4">
                        <!-- Items injected here -->
                    </div>
                    <div id="emptyCartMsg" class="hidden text-center py-10 text-gray-500">
                        <i class="fa-solid fa-cart-arrow-down text-4xl mb-3"></i>
                        <p>Your cart is empty</p>
                        <button onclick="router('home')" class="mt-4 text-brand-600 font-semibold hover:underline">Start Shopping</button>
                    </div>
                </div>

                <!-- Summary -->
                <div class="w-full lg:w-80 bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6 border border-gray-200 dark:border-gray-700 h-fit sticky top-24">
                    <h3 class="font-bold text-lg mb-4">Order Summary</h3>
                    <div class="flex justify-between mb-2 text-sm">
                        <span>Subtotal</span>
                        <span id="cartSubtotal">$0.00</span>
                    </div>
                    <div class="flex justify-between mb-4 text-sm">
                        <span>Shipping</span>
                        <span class="text-green-500">Free</span>
                    </div>
                    <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mb-6">
                        <div class="flex justify-between font-bold text-lg">
                            <span>Total</span>
                            <span id="cartTotal">$0.00</span>
                        </div>
                    </div>
                    <button onclick="router('checkout')" id="checkoutBtn" class="w-full bg-daraz-orange text-white py-3 rounded-lg font-bold hover:bg-orange-600 transition-colors">
                        Checkout
                    </button>
                </div>
            </div>
        </div>

        <!-- VIEW: CHECKOUT -->
        <div id="view-checkout" class="hidden-view fade-in max-w-4xl mx-auto">
            <h2 class="text-2xl font-bold mb-6">Checkout</h2>
            <div class="grid md:grid-cols-3 gap-6">
                <!-- Form -->
                <div class="md:col-span-2 bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6 border border-gray-200 dark:border-gray-700">
                    <h3 class="font-bold text-lg mb-4">Shipping Information</h3>
                    <form id="checkoutForm" onsubmit="handleCheckout(event)">
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm mb-1">Full Name</label>
                                <input type="text" id="shipName" required class="w-full px-3 py-2 rounded border dark:bg-gray-700 dark:border-gray-600">
                            </div>
                            <div>
                                <label class="block text-sm mb-1">Phone Number</label>
                                <input type="tel" id="shipPhone" required class="w-full px-3 py-2 rounded border dark:bg-gray-700 dark:border-gray-600">
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm mb-1">Address</label>
                            <textarea id="shipAddress" required rows="3" class="w-full px-3 py-2 rounded border dark:bg-gray-700 dark:border-gray-600"></textarea>
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm mb-1">City</label>
                            <input type="text" id="shipCity" required class="w-full px-3 py-2 rounded border dark:bg-gray-700 dark:border-gray-600">
                        </div>

                        <h3 class="font-bold text-lg mb-4">Payment Method</h3>
                        <div class="p-4 border border-daraz-orange bg-orange-50 dark:bg-gray-700 rounded-lg flex items-center gap-3">
                            <i class="fa-solid fa-money-bill-wave text-daraz-orange text-xl"></i>
                            <div>
                                <p class="font-bold text-sm">Cash on Delivery</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">Pay when you receive your order</p>
                            </div>
                        </div>

                        <button type="submit" class="mt-6 w-full bg-daraz-orange text-white py-3 rounded-lg font-bold hover:bg-orange-600 transition-colors">
                            Place Order
                        </button>
                    </form>
                </div>

                <!-- Review -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6 border border-gray-200 dark:border-gray-700 h-fit">
                    <h3 class="font-bold text-lg mb-4">Order Review</h3>
                    <div id="checkoutItems" class="space-y-3 mb-4 max-h-60 overflow-y-auto">
                        <!-- Items -->
                    </div>
                    <div class="border-t pt-4">
                        <div class="flex justify-between font-bold text-xl">
                            <span>Total</span>
                            <span id="checkoutTotal">$0.00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: ADMIN DASHBOARD -->
        <div id="view-admin" class="hidden-view fade-in">
            <div class="flex flex-col md:flex-row gap-6">
                <!-- Sidebar -->
                <div class="w-full md:w-64 bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-4 h-fit">
                    <div class="mb-6 px-2">
                        <h2 class="text-xl font-bold text-daraz-orange">Admin Panel</h2>
                        <p class="text-xs text-gray-500" id="adminEmailDisplay">admin@uashop.com</p>
                    </div>
                    <nav class="space-y-1">
                        <button onclick="switchAdminTab('dashboard')" class="w-full text-left px-4 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 font-medium admin-nav-btn" data-tab="dashboard">Dashboard</button>
                        <button onclick="switchAdminTab('products')" class="w-full text-left px-4 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 font-medium admin-nav-btn" data-tab="products">Products</button>
                        <button onclick="switchAdminTab('orders')" class="w-full text-left px-4 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 font-medium admin-nav-btn" data-tab="orders">Orders</button>
                        <button onclick="switchAdminTab('users')" class="w-full text-left px-4 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 font-medium admin-nav-btn" data-tab="users">Users</button>
                    </nav>
                    <button onclick="logout()" class="mt-8 w-full text-left px-4 py-2 rounded text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 font-medium">
                        <i class="fa-solid fa-sign-out-alt mr-2"></i> Logout
                    </button>
                </div>

                <!-- Content -->
                <div class="flex-1">
                    <!-- Dashboard Stats -->
                    <div id="admin-dashboard" class="admin-tab-content">
                        <h2 class="text-2xl font-bold mb-6">Overview</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
                                <p class="text-gray-500 text-sm">Total Orders</p>
                                <p class="text-3xl font-bold" id="statOrders">0</p>
                            </div>
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
                                <p class="text-gray-500 text-sm">Total Revenue</p>
                                <p class="text-3xl font-bold text-green-500" id="statRevenue">$0</p>
                            </div>
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
                                <p class="text-gray-500 text-sm">Total Products</p>
                                <p class="text-3xl font-bold" id="statProducts">0</p>
                            </div>
                        </div>
                    </div>

                    <!-- Products Manager -->
                    <div id="admin-products" class="admin-tab-content hidden-view">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">Product Management</h2>
                            <button onclick="openProductModal()" class="bg-brand-600 text-white px-4 py-2 rounded hover:bg-brand-700">
                                <i class="fa-solid fa-plus mr-2"></i> Add Product
                            </button>
                        </div>
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
                            <table class="w-full text-left">
                                <thead class="bg-gray-50 dark:bg-gray-700 border-b dark:border-gray-600">
                                    <tr>
                                        <th class="p-4">Product</th>
                                        <th class="p-4">Price</th>
                                        <th class="p-4">Stock</th>
                                        <th class="p-4">Type</th>
                                        <th class="p-4">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="adminProductTable" class="divide-y divide-gray-200 dark:divide-gray-700">
                                    <!-- Rows -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Orders Manager -->
                    <div id="admin-orders" class="admin-tab-content hidden-view">
                        <h2 class="text-2xl font-bold mb-6">Order Management</h2>
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
                            <table class="w-full text-left">
                                <thead class="bg-gray-50 dark:bg-gray-700 border-b dark:border-gray-600">
                                    <tr>
                                        <th class="p-4">Order ID</th>
                                        <th class="p-4">Customer</th>
                                        <th class="p-4">Total</th>
                                        <th class="p-4">Status</th>
                                        <th class="p-4">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="adminOrderTable" class="divide-y divide-gray-200 dark:divide-gray-700">
                                    <!-- Rows -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Users Manager -->
                    <div id="admin-users" class="admin-tab-content hidden-view">
                        <h2 class="text-2xl font-bold mb-6">User Management</h2>
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
                            <table class="w-full text-left">
                                <thead class="bg-gray-50 dark:bg-gray-700 border-b dark:border-gray-600">
                                    <tr>
                                        <th class="p-4">Email</th>
                                        <th class="p-4">Role</th>
                                        <th class="p-4">Status</th>
                                        <th class="p-4">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="adminUserTable" class="divide-y divide-gray-200 dark:divide-gray-700">
                                    <!-- Rows -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Product Modal (Add/Edit) -->
    <div id="productModal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg w-full max-w-lg max-h-[90vh] overflow-y-auto p-6 relative">
            <button onclick="closeProductModal()" class="absolute top-4 right-4 text-gray-500 hover:text-red-500">
                <i class="fa-solid fa-times text-xl"></i>
            </button>
            <h3 class="text-xl font-bold mb-4" id="modalTitle">Add Product</h3>
            <form id="productForm" onsubmit="handleProductSubmit(event)">
                <input type="hidden" id="prodId">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm mb-1">Name</label>
                        <input type="text" id="prodName" required class="w-full px-3 py-2 rounded border dark:bg-gray-700 dark:border-gray-600">
                    </div>
                    <div>
                        <label class="block text-sm mb-1">Description</label>
                        <textarea id="prodDesc" required rows="3" class="w-full px-3 py-2 rounded border dark:bg-gray-700 dark:border-gray-600"></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm mb-1">Price ($)</label>
                            <input type="number" step="0.01" id="prodPrice" required class="w-full px-3 py-2 rounded border dark:bg-gray-700 dark:border-gray-600">
                        </div>
                        <div>
                            <label class="block text-sm mb-1">Stock</label>
                            <input type="number" id="prodStock" required class="w-full px-3 py-2 rounded border dark:bg-gray-700 dark:border-gray-600">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm mb-1">Category</label>
                            <select id="prodCategory" class="w-full px-3 py-2 rounded border dark:bg-gray-700 dark:border-gray-600">
                                <option value="Electronics">Electronics</option>
                                <option value="Fashion">Fashion</option>
                                <option value="Digital">Digital</option>
                                <option value="Home">Home</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm mb-1">Type</label>
                            <select id="prodType" class="w-full px-3 py-2 rounded border dark:bg-gray-700 dark:border-gray-600">
                                <option value="physical">Physical</option>
                                <option value="digital">Digital</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm mb-1">Image URL</label>
                        <input type="url" id="prodImage" required placeholder="https://..." class="w-full px-3 py-2 rounded border dark:bg-gray-700 dark:border-gray-600">
                        <p class="text-xs text-gray-500 mt-1">Use a direct image link.</p>
                    </div>
                </div>
                <button type="submit" class="mt-6 w-full bg-brand-600 text-white py-2 rounded hover:bg-brand-700">Save Product</button>
            </form>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-[70]">
        Message here
    </div>

    <!-- Firebase & App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, query, where, addDoc, increment, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyDHFmDWXrBndIN-e2J11jZnVQXGhkr7P2A",
            authDomain: "u-a-shop.firebaseapp.com",
            projectId: "u-a-shop",
            storageBucket: "u-a-shop.firebasestorage.app",
            messagingSenderId: "642153392447",
            appId: "1:642153392447:web:6822d56b0120c56ef4cb8a"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Global State ---
        let currentUser = null;
        let cart = []; // Array of {id, qty, ...productData}
        let products = [];
        let isAdmin = false;

        // --- DOM Elements ---
        const views = {
            home: document.getElementById('view-home'),
            auth: document.getElementById('view-auth'),
            cart: document.getElementById('view-cart'),
            checkout: document.getElementById('view-checkout'),
            admin: document.getElementById('view-admin')
        };
        const authSection = document.getElementById('authSection');
        const productGrid = document.getElementById('productGrid');
        const cartCountBadge = document.getElementById('cartCountBadge');
        const globalLoader = document.getElementById('globalLoader');

        // --- Initialization ---
        window.addEventListener('DOMContentLoaded', () => {
            initTheme();
            loadProducts();
            
            onAuthStateChanged(auth, async (user) => {
                currentUser = user;
                if (user) {
                    await checkUserRole(user);
                    await loadCart();
                    updateAuthUI(true);
                } else {
                    isAdmin = false;
                    cart = []; // Clear cart if logged out (or keep local, but simplified here)
                    updateAuthUI(false);
                    updateCartUI();
                }
            });
        });

        // --- Theme Logic ---
        function initTheme() {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }

        window.toggleDarkMode = () => {
            document.documentElement.classList.toggle('dark');
            localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
        };

        // --- Routing ---
        window.router = (viewName) => {
            // Hide all views
            Object.values(views).forEach(el => el.classList.add('hidden-view'));
            
            // Show requested view
            if (views[viewName]) {
                views[viewName].classList.remove('hidden-view');
            }

            // Specific Logic
            if (viewName === 'cart') updateCartUI();
            if (viewName === 'checkout') prepareCheckout();
            if (viewName === 'admin') loadAdminData();
            
            window.scrollTo(0,0);
        };

        // --- Auth Logic ---
        let isLoginMode = true;
        window.toggleAuthMode = () => {
            isLoginMode = !isLoginMode;
            document.querySelector('#view-auth h2').textContent = isLoginMode ? 'Login' : 'Sign Up';
            document.getElementById('authBtn').textContent = isLoginMode ? 'Login' : 'Sign Up';
            document.getElementById('authToggleText').textContent = isLoginMode ? "Don't have an account? " : "Already have an account? ";
            document.querySelector('#view-auth button:last-child').textContent = isLoginMode ? 'Sign Up' : 'Login';
        };

        window.handleAuthSubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            showLoader(true);

            try {
                if (isLoginMode) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    const cred = await createUserWithEmailAndPassword(auth, email, password);
                    // Create user doc in Firestore
                    await setDoc(doc(db, "users", cred.user.uid), {
                        email: email,
                        role: 'customer',
                        blocked: false,
                        createdAt: serverTimestamp()
                    });
                }
                showToast(isLoginMode ? "Logged in successfully" : "Account created");
                router('home');
            } catch (error) {
                showToast("Error: " + error.message, true);
            } finally {
                showLoader(false);
            }
        };

        window.logout = async () => {
            await signOut(auth);
            router('home');
            showToast("Logged out");
        };

        function updateAuthUI(isLoggedIn) {
            if (isLoggedIn) {
                const displayName = currentUser.email.split('@')[0];
                authSection.innerHTML = `
                    <div class="flex items-center gap-2 cursor-pointer" onclick="router('${isAdmin ? 'admin' : 'home'}')">
                        <div class="w-8 h-8 rounded-full bg-brand-500 text-white flex items-center justify-center font-bold text-sm">
                            ${displayName.charAt(0).toUpperCase()}
                        </div>
                        <span class="hidden md:inline text-sm font-medium">${displayName}</span>
                        ${isAdmin ? '<span class="bg-red-500 text-white text-[10px] px-1 rounded">ADMIN</span>' : ''}
                    </div>
                `;
            } else {
                authSection.innerHTML = `
                    <button onclick="router('auth')" class="bg-daraz-orange text-white px-4 py-1.5 rounded hover:bg-orange-600 text-sm font-medium">
                        Login / Sign Up
                    </button>
                `;
            }
        }

        async function checkUserRole(user) {
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (userDoc.exists()) {
                const data = userDoc.data();
                isAdmin = data.role === 'admin';
                if(data.blocked) {
                    showToast("Account blocked. Contact support.", true);
                    logout();
                }
            }
        }

        // --- Product Logic ---
        async function loadProducts() {
            showLoader(true);
            const q = query(collection(db, "products"));
            const snapshot = await getDocs(q);
            products = [];
            snapshot.forEach(doc => {
                products.push({ id: doc.id, ...doc.data() });
            });
            renderProducts(products);
            showLoader(false);
        }

        function renderProducts(list) {
            productGrid.innerHTML = '';
            if(list.length === 0) {
                productGrid.innerHTML = '<div class="col-span-full text-center py-10 text-gray-500">No products found.</div>';
                return;
            }
            list.forEach(p => {
                const card = document.createElement('div');
                card.className = "product-card bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden flex flex-col h-full";
                card.innerHTML = `
                    <div class="h-48 overflow-hidden relative bg-gray-100 dark:bg-gray-700">
                        <img src="${p.images[0]}" alt="${p.name}" class="w-full h-full object-cover">
                        ${p.discount > 0 ? `<span class="absolute top-2 left-2 bg-daraz-red text-white text-xs font-bold px-2 py-1 rounded">-${p.discount}%</span>` : ''}
                    </div>
                    <div class="p-3 flex flex-col flex-1">
                        <h3 class="font-medium text-sm md:text-base line-clamp-2 mb-1 h-10">${p.name}</h3>
                        <div class="mt-auto">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-lg font-bold text-daraz-orange">$${p.price.toFixed(2)}</span>
                                ${p.discount > 0 ? `<span class="text-xs text-gray-400 line-through">$${(p.price * (1 + p.discount/100)).toFixed(2)}</span>` : ''}
                            </div>
                            <button onclick="addToCart('${p.id}')" class="w-full bg-brand-600 text-white py-1.5 rounded text-sm hover:bg-brand-700 transition-colors">
                                Add to Cart
                            </button>
                        </div>
                    </div>
                `;
                productGrid.appendChild(card);
            });
        }

        window.filterCategory = (cat) => {
            if (cat === 'all') renderProducts(products);
            else renderProducts(products.filter(p => p.category === cat || (cat === 'Digital' && p.productType === 'digital')));
        };

        window.handleSearch = () => {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const filtered = products.filter(p => p.name.toLowerCase().includes(term));
            renderProducts(filtered);
        };

        // --- Cart Logic ---
        async function loadCart() {
            if (!currentUser) return;
            const cartRef = doc(db, "carts", currentUser.uid);
            const cartDoc = await getDoc(cartRef);
            if (cartDoc.exists()) {
                cart = cartDoc.data().items || [];
            } else {
                cart = [];
            }
            updateCartUI();
        }

        window.addToCart = async (prodId) => {
            const product = products.find(p => p.id === prodId);
            if (!product) return;

            const existing = cart.find(item => item.id === prodId);
            if (existing) {
                existing.qty++;
            } else {
                cart.push({ ...product, qty: 1 });
            }

            updateCartUI();
            
            if (currentUser) {
                // Sync to Firestore
                await setDoc(doc(db, "carts", currentUser.uid), { items: cart });
            }
            showToast("Added to cart");
        };

        window.removeFromCart = async (prodId) => {
            cart = cart.filter(item => item.id !== prodId);
            updateCartUI();
            if (currentUser) {
                await setDoc(doc(db, "carts", currentUser.uid), { items: cart });
            }
        };

        window.updateQty = async (prodId, change) => {
            const item = cart.find(i => i.id === prodId);
            if (item) {
                item.qty += change;
                if (item.qty <= 0) item.qty = 1;
                updateCartUI();
                if (currentUser) {
                    await setDoc(doc(db, "carts", currentUser.uid), { items: cart });
                }
            }
        };

        function updateCartUI() {
            const container = document.getElementById('cartItemsContainer');
            const emptyMsg = document.getElementById('emptyCartMsg');
            const checkoutBtn = document.getElementById('checkoutBtn');
            
            container.innerHTML = '';
            let total = 0;
            let count = 0;

            if (cart.length === 0) {
                emptyMsg.classList.remove('hidden');
                checkoutBtn.disabled = true;
                checkoutBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                emptyMsg.classList.add('hidden');
                checkoutBtn.disabled = false;
                checkoutBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }

            cart.forEach(item => {
                total += item.price * item.qty;
                count += item.qty;
                
                const row = document.createElement('div');
                row.className = "flex items-center gap-4 border-b border-gray-100 dark:border-gray-700 pb-4 last:border-0";
                row.innerHTML = `
                    <img src="${item.images[0]}" class="w-16 h-16 object-cover rounded bg-gray-100">
                    <div class="flex-1">
                        <h4 class="font-medium text-sm line-clamp-1">${item.name}</h4>
                        <p class="text-daraz-orange font-bold">$${item.price.toFixed(2)}</p>
                    </div>
                    <div class="flex items-center gap-3 bg-gray-100 dark:bg-gray-700 rounded px-2 py-1">
                        <button onclick="updateQty('${item.id}', -1)" class="w-6 h-6 flex items-center justify-center text-gray-600 dark:text-gray-300">-</button>
                        <span class="text-sm font-medium w-4 text-center">${item.qty}</span>
                        <button onclick="updateQty('${item.id}', 1)" class="w-6 h-6 flex items-center justify-center text-gray-600 dark:text-gray-300">+</button>
                    </div>
                    <button onclick="removeFromCart('${item.id}')" class="text-gray-400 hover:text-red-500">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                `;
                container.appendChild(row);
            });

            document.getElementById('cartSubtotal').textContent = `$${total.toFixed(2)}`;
            document.getElementById('cartTotal').textContent = `$${total.toFixed(2)}`;
            cartCountBadge.textContent = count;
        }

        // --- Checkout Logic ---
        function prepareCheckout() {
            if (!currentUser) {
                showToast("Please login to checkout", true);
                router('auth');
                return;
            }
            const container = document.getElementById('checkoutItems');
            container.innerHTML = '';
            let total = 0;
            cart.forEach(item => {
                total += item.price * item.qty;
                container.innerHTML += `
                    <div class="flex justify-between text-sm">
                        <span>${item.name} x${item.qty}</span>
                        <span>$${(item.price * item.qty).toFixed(2)}</span>
                    </div>
                `;
            });
            document.getElementById('checkoutTotal').textContent = `$${total.toFixed(2)}`;
        }

        window.handleCheckout = async (e) => {
            e.preventDefault();
            if (!currentUser) return;

            showLoader(true);
            const orderData = {
                userId: currentUser.uid,
                userEmail: currentUser.email,
                items: cart,
                total: cart.reduce((acc, item) => acc + (item.price * item.qty), 0),
                shipping: {
                    name: document.getElementById('shipName').value,
                    phone: document.getElementById('shipPhone').value,
                    address: document.getElementById('shipAddress').value,
                    city: document.getElementById('shipCity').value
                },
                paymentMethod: 'COD',
                status: 'Pending',
                createdAt: serverTimestamp()
            };

            try {
                await addDoc(collection(db, "orders"), orderData);
                
                // Clear Cart
                cart = [];
                await setDoc(doc(db, "carts", currentUser.uid), { items: [] });
                updateCartUI();
                
                showToast("Order placed successfully!");
                router('home');
            } catch (error) {
                showToast("Order failed: " + error.message, true);
            } finally {
                showLoader(false);
            }
        };

        // --- Admin Logic ---
        window.switchAdminTab = (tab) => {
            document.querySelectorAll('.admin-tab-content').forEach(el => el.classList.add('hidden-view'));
            document.getElementById(`admin-${tab}`).classList.remove('hidden-view');
            
            document.querySelectorAll('.admin-nav-btn').forEach(btn => {
                btn.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'font-bold');
                if(btn.dataset.tab === tab) btn.classList.add('bg-gray-100', 'dark:bg-gray-700', 'font-bold');
            });
        };

        async function loadAdminData() {
            if (!isAdmin) {
                router('home');
                return;
            }
            
            document.getElementById('adminEmailDisplay').textContent = currentUser.email;
            
            // Stats
            const ordersSnap = await getDocs(collection(db, "orders"));
            const productsSnap = await getDocs(collection(db, "products"));
            const usersSnap = await getDocs(collection(db, "users"));
            
            let revenue = 0;
            ordersSnap.forEach(d => {
                const data = d.data();
                if(data.status !== 'Cancelled') revenue += (data.total || 0);
            });

            document.getElementById('statOrders').textContent = ordersSnap.size;
            document.getElementById('statRevenue').textContent = `$${revenue.toFixed(2)}`;
            document.getElementById('statProducts').textContent = productsSnap.size;

            // Populate Tables
            populateAdminProducts(productsSnap);
            populateAdminOrders(ordersSnap);
            populateAdminUsers(usersSnap);
        }

        function populateAdminProducts(snap) {
            const tbody = document.getElementById('adminProductTable');
            tbody.innerHTML = '';
            snap.forEach(doc => {
                const p = doc.data();
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-4 flex items-center gap-3">
                        <img src="${p.images[0]}" class="w-10 h-10 object-cover rounded">
                        <span class="font-medium">${p.name}</span>
                    </td>
                    <td class="p-4">$${p.price}</td>
                    <td class="p-4">${p.stock}</td>
                    <td class="p-4"><span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs">${p.productType}</span></td>
                    <td class="p-4">
                        <button onclick="editProduct('${doc.id}')" class="text-blue-500 hover:underline mr-2">Edit</button>
                        <button onclick="deleteProduct('${doc.id}')" class="text-red-500 hover:underline">Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function populateAdminOrders(snap) {
            const tbody = document.getElementById('adminOrderTable');
            tbody.innerHTML = '';
            // Sort by date desc roughly
            const arr = [];
            snap.forEach(d => arr.push({id: d.id, ...d.data()}));
            arr.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

            arr.forEach(o => {
                const tr = document.createElement('tr');
                let statusClass = 'bg-yellow-100 text-yellow-800';
                if(o.status === 'Delivered') statusClass = 'bg-green-100 text-green-800';
                if(o.status === 'Cancelled') statusClass = 'bg-red-100 text-red-800';

                tr.innerHTML = `
                    <td class="p-4 font-mono text-xs">${o.id.substring(0,8)}...</td>
                    <td class="p-4">${o.shipping.name}</td>
                    <td class="p-4">$${o.total.toFixed(2)}</td>
                    <td class="p-4"><span class="px-2 py-1 rounded text-xs font-bold ${statusClass}">${o.status}</span></td>
                    <td class="p-4">
                        <select onchange="updateOrderStatus('${o.id}', this.value)" class="text-xs border rounded p-1 dark:bg-gray-700">
                            <option value="Pending" ${o.status==='Pending'?'selected':''}>Pending</option>
                            <option value="Processing" ${o.status==='Processing'?'selected':''}>Processing</option>
                            <option value="Delivered" ${o.status==='Delivered'?'selected':''}>Delivered</option>
                            <option value="Cancelled" ${o.status==='Cancelled'?'selected':''}>Cancelled</option>
                        </select>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function populateAdminUsers(snap) {
            const tbody = document.getElementById('adminUserTable');
            tbody.innerHTML = '';
            snap.forEach(doc => {
                const u = doc.data();
                // Don't show self in list to avoid confusion, or allow self-edit
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-4">${u.email}</td>
                    <td class="p-4 capitalize">${u.role}</td>
                    <td class="p-4">${u.blocked ? '<span class="text-red-500 font-bold">Blocked</span>' : '<span class="text-green-500">Active</span>'}</td>
                    <td class="p-4">
                        ${u.role !== 'admin' ? `<button onclick="toggleBlockUser('${doc.id}', ${u.blocked})" class="text-sm text-brand-600 hover:underline">${u.blocked ? 'Unblock' : 'Block'}</button>` : ''}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Admin Actions
        window.updateOrderStatus = async (id, status) => {
            await updateDoc(doc(db, "orders", id), { status });
            showToast("Status updated");
            loadAdminData();
        };

        window.toggleBlockUser = async (id, currentStatus) => {
            await updateDoc(doc(db, "users", id), { blocked: !currentStatus });
            showToast("User status updated");
            loadAdminData();
        };

        window.deleteProduct = async (id) => {
            if(confirm("Are you sure?")) {
                await deleteDoc(doc(db, "products", id));
                loadAdminData();
                loadProducts(); // Refresh store
            }
        };

        // Product Modal Logic
        window.openProductModal = () => {
            document.getElementById('productForm').reset();
            document.getElementById('prodId').value = '';
            document.getElementById('modalTitle').textContent = 'Add Product';
            document.getElementById('productModal').classList.remove('hidden');
        };

        window.closeProductModal = () => {
            document.getElementById('productModal').classList.add('hidden');
        };

        window.editProduct = (id) => {
            const p = products.find(x => x.id === id);
            if(!p) return;
            document.getElementById('prodId').value = id;
            document.getElementById('prodName').value = p.name;
            document.getElementById('prodDesc').value = p.description;
            document.getElementById('prodPrice').value = p.price;
            document.getElementById('prodStock').value = p.stock;
            document.getElementById('prodCategory').value = p.category;
            document.getElementById('prodType').value = p.productType;
            document.getElementById('prodImage').value = p.images[0];
            
            document.getElementById('modalTitle').textContent = 'Edit Product';
            document.getElementById('productModal').classList.remove('hidden');
        };

        window.handleProductSubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('prodId').value;
            const data = {
                name: document.getElementById('prodName').value,
                description: document.getElementById('prodDesc').value,
                price: parseFloat(document.getElementById('prodPrice').value),
                stock: parseInt(document.getElementById('prodStock').value),
                category: document.getElementById('prodCategory').value,
                productType: document.getElementById('prodType').value,
                images: [document.getElementById('prodImage').value],
                discount: 0,
                createdAt: serverTimestamp()
            };

            showLoader(true);
            try {
                if (id) {
                    await updateDoc(doc(db, "products", id), data);
                } else {
                    await addDoc(collection(db, "products"), data);
                }
                closeProductModal();
                loadAdminData();
                loadProducts();
                showToast("Product saved");
            } catch (err) {
                showToast(err.message, true);
            } finally {
                showLoader(false);
            }
        };

        // --- Utilities ---
        function showLoader(show) {
            globalLoader.style.display = show ? 'flex' : 'none';
        }

        function showToast(msg, isError = false) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.style.backgroundColor = isError ? '#ef4444' : '#1f2937';
            t.style.transform = 'translateY(0)';
            t.style.opacity = '1';
            setTimeout(() => {
                t.style.transform = 'translateY(20px)';
                t.style.opacity = '0';
            }, 3000);
        }

    </script>
</body>
</html>

